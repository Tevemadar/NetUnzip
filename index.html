<!DOCTYPE html>
<html>
    <head>
        <title>Demo page for NetUnzip</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            div,pre,img{
                display: none;
                background: lightgrey;
                position: fixed;
                top:0;
                bottom:0;
                left:0;
                right:0;
                margin:auto;
            }
            div{
                width: 80%;
                height: 80%;
            }
            pre{
                width: max-content;
                max-width: 80%;
                height: max-content;
                white-space: pre-wrap;
            }
        </style>
        <script src="netunzip.js"></script>
        <script src="inflater.js"></script>
        <script>
            async function tempurl() {
                return fetch("https://data-proxy.ebrains.eu/api/v1/public/buckets/watest/1362_4645_6647_D1R_P70_M_C17_s001.zip?redirect=false").then(response => response.json()).then(json => json.url);
            }
            let zipdir;
            async function startup() {
                const log = document.getElementById("log");
                const start = Date.now();
                zipdir = await netunzip(location.search ? location.search.substring(1) : tempurl);
                log.innerText += `Got parsed directory @${Date.now() - start} ms.`;
                let tab = "";
                for (const [_, entry] of zipdir.entries) {
                    let line = `<td><button onclick="load(event)">${entry.name}</button></td>`;
                    line += `<td>${entry.timestamp}</td>`;
                    line += `<td>${entry.uncompsize}</td>`;
                    line += `<td>${entry.offset}</td>`;
                    line += `<td>${entry.compsize}</td>`;
                    line += `<td>${entry.method}</td>`;
                    line += `<td>${entry.crc.toString(16).toUpperCase().padStart(8, "0")}</td>`;
                    line += `<td>${entry.diskno}</td>`;
                    line += `<td>${entry.gpflags.toString(16)},${entry.intattrs.toString(16)},${entry.extattrs.toString(16)}</td>`;
                    line += `<td>${entry.comment}</td>`;
                    tab += `<tr>${line}</tr>`;
                }
                document.getElementById("dir").innerHTML = tab;
                log.innerText += ` Built table @${Date.now() - start} ms.`;
            }
            async function load(event) {
                let entry = zipdir.entries.get(event.target.innerText);
                if (entry.uncompsize === 0) {
                    alert("That's an empty file or a directory.");
                    return;
                }
                let data = await zipdir.get(entry);
                popup.style.display = "block";
                if (entry.name.endsWith(".xml") || entry.name.endsWith(".txt")) {
                    pre.innerText = new TextDecoder().decode(data);
                    pre.style.display = "block";
                    img.style.display = "none";
                }
                if (entry.name.endsWith(".png")) {
                    img.src = URL.createObjectURL(new Blob([data], {type: "image/png"}));
                    pre.style.display = "none";
                    img.style.display = "block";
                }
            }
        </script>
    </head>
    <body onload="startup()" onclick="popup.style.display = 'none'">
        <span id="log"></span><br>
        <table>
            <thead>
                <tr>
                    <th>name</th>
                    <th>timestamp</th>
                    <th>size</th>
                    <th>offset</th>
                    <th>csize</th>
                    <th>cmethod</th>
                    <th>crc</th>
                    <th>disk</th>
                    <th>flags,atts</th>
                    <th>comment</th>
                </tr>
            </thead>
            <tbody id="dir"></tbody>
        </table>
        <div id="popup"><pre id="pre"></pre><img id="img" src="" onload="globalThis.URL.revokeObjectURL(event.target.src);"></div>
    </body>
</html>
